<!DOCTYPE html>
<html>
<head>
    <title>ThingSpeak Environmental Dashboard</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; color: #333; background-color: #f4f7f6; }
        #controls-panel { 
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding: 20px; border: 1px solid #ddd; 
            border-radius: 12px; background-color: #ffffff; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .control-section { display: flex; flex-direction: column; gap: 10px; }
        .input-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        label { font-size: 14px; font-weight: bold; }
        input[type="datetime-local"] { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; border: 1px solid #ccc; }
        #apply_filter_button { background-color: #007bff; color: white; border: none; }
        .btn-pdf { background-color: #d9534f; color: white; border: none; }
        .refresh-group { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: #666; padding-left: 15px; border-left: 2px solid #eee; }
        #timer_display { color: #d9534f; font-family: monospace; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; font-size: 13px; }
        #dashboard_div { background: white; padding: 25px; border-radius: 12px; border: 1px solid #ddd; }
        #chart_div { width: 100%; height: 600px; }
        #filter_div { width: 100%; height: 70px; margin-top: 10px; }
        #loading_status { margin-top: 10px; font-size: 13px; font-weight: 600; color: #666; }
        @media print {
            #controls-panel, #loading_status, #filter_div { display: none !important; }
            #dashboard_div { border: none; padding: 0; }
        }
    </style>
</head>
<body>

<div id="controls-panel">
    <div class="control-section">
        <label>Time Frame & Refresh:</label>
        <div class="input-row">
            <span>From:</span> <input type="datetime-local" id="start_date_input">
            <span>To:</span> <input type="datetime-local" id="end_date_input">
            <button id="apply_filter_button">Update Graph</button>
            <button class="btn-pdf" onclick="window.print()">Save PDF</button>
            <div class="refresh-group">
                <input type="checkbox" id="auto_refresh_chkbx" onchange="toggleAutoRefresh()"> <span>Live</span> <span id="timer_display"></span>
            </div>
        </div>
    </div>
    <div class="control-section">
        <label>Select Series:</label>
        <div class="checkbox-group">
            <span><input type="checkbox" id="field3" checked onclick="applyDateFilter()"> Ambient Temp</span>
            <span><input type="checkbox" id="field4" checked onclick="applyDateFilter()"> Ambient RH</span>
            <span><input type="checkbox" id="field5" checked onclick="applyDateFilter()"> Healing Temp</span>
            <span><input type="checkbox" id="field6" checked onclick="applyDateFilter()"> Healing RH</span>
            <span><input type="checkbox" id="field7" checked onclick="applyDateFilter()"> Pressure</span>
        </div>
    </div>
</div>
    
<div id="dashboard_div"> 
    <div id="chart_div"></div>
    <div id="filter_div"></div>
</div>
<div id="loading_status">Initializing...</div>

<script type="text/javascript">
    const CHANNEL_ID = 77784; 
    let dashboard, fullDataFeeds = [], countdownInterval = null, secondsRemaining = 900;

    google.charts.load('current', {'packages': ['corechart', 'controls']});
    google.charts.setOnLoadCallback(() => {
        const end = new Date();
        const start = new Date(end.getTime() - (7 * 24 * 60 * 60 * 1000));
        document.getElementById('start_date_input').value = formatDateToInput(start);
        document.getElementById('end_date_input').value = formatDateToInput(end);
        document.getElementById('apply_filter_button').onclick = applyDateFilter;
        applyDateFilter();
    });

    function formatDateToInput(date) {
        const pad = (n) => String(n).padStart(2, '0');
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    async function applyDateFilter() {
        const start = new Date(document.getElementById('start_date_input').value);
        const end = new Date(document.getElementById('end_date_input').value);
        if (isNaN(start) || isNaN(end) || start >= end) return;

        document.getElementById('loading_status').textContent = 'Fetching 8000 points...';
        const tsEnd = end.toISOString().split('.')[0].replace('T', '%20');
        const rangeHours = (end - start) / 3600000;
        const avg = rangeHours > 48 ? '&average=14400' : '';
        const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=8000&end=${tsEnd}${avg}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            fullDataFeeds = data.feeds || [];
            drawDashboard();
            document.getElementById('loading_status').textContent = `Loaded ${fullDataFeeds.length} points.`;
        } catch (e) {
            document.getElementById('loading_status').textContent = 'Error fetching data.';
        }
    }

    function drawDashboard() {
        if (fullDataFeeds.length === 0) return;
        const dt = new google.visualization.DataTable();
        dt.addColumn('datetime', 'Time');
        const fieldMap = {3:'Ambient Temp', 4:'Ambient RH', 5:'Healing Temp', 6:'Healing RH', 7:'Pressure'};
        const active = [3,4,5,6,7].filter(f => document.getElementById('field'+f).checked);
        active.forEach(f => dt.addColumn('number', fieldMap[f]));

        fullDataFeeds.forEach(f => {
            const row = [new Date(f.created_at)];
            active.forEach(af => row.push(f['field'+af] ? parseFloat(f['field'+af]) : null));
            dt.addRow(row);
        });

        dashboard = new google.visualization.Dashboard(document.getElementById('dashboard_div'));
        const filter = new google.visualization.ControlWrapper({
            'controlType': 'ChartRangeFilter', 'containerId': 'filter_div',
            'options': { 'filterColumnIndex': 0, 'ui': { 'chartOptions': { 'height': 50, 'chartArea': {'width': '90%'} } } }
        });
        const chart = new google.visualization.ChartWrapper({
            'chartType': 'LineChart', 'containerId': 'chart_div',
            'options': { 'height': 600, 'interpolateNulls': true, 'legend': 'bottom', 'chartArea': {'left': 60, 'right': 40, 'top': 40, 'bottom': 60} }
        });
        dashboard.bind(filter, chart);
        dashboard.draw(dt);
    }

    function toggleAutoRefresh() {
        clearInterval(countdownInterval);
        if (document.getElementById('auto_refresh_chkbx').checked) {
            secondsRemaining = 900;
            countdownInterval = setInterval(() => {
                secondsRemaining--;
                document.getElementById('timer_display').textContent = `(${Math.floor(secondsRemaining/60)}:${(secondsRemaining%60).toString().padStart(2,'0')})`;
                if (secondsRemaining <= 0) {
                    document.getElementById('end_date_input').value = formatDateToInput(new Date());
                    applyDateFilter();
                    secondsRemaining = 900;
                }
            }, 1000);
        } else { document.getElementById('timer_display').textContent = ''; }
    }
</script>
</body>
</html>